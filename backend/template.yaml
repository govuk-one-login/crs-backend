AWSTemplateFormatVersion: "2010-09-09"

Description: Scheduled Lambda Function with esbuild Build

Parameters:
  CodeSigningConfigArn:
    Description: The ARN of the Code Signing Config to use, provided by the deployment pipeline
    Type: String
    Default: none

  Environment:
    Description: The name of the environment to deploy to
    Type: String
    AllowedValues:
      - dev
      - build
      - staging
      - integration
      - production
    Default: dev

  PermissionsBoundary:
    Description: |
      The ARN of the permissions boundary to apply to any role created by the template
    Type: String
    Default: none

  VpcStackName:
    Description: |
      The stack name of the VPC where the Lambda functions will be deployed
    Type: String
    Default: devplatform-vpc

Mappings:
  EnvironmentVariables:
    dev:
      CertificateArnV1UsEast1: arn:aws:acm:us-east-1:537124944731:certificate/b0322e50-f75b-4fa3-ac65-4a42ac2380d3
      CertificateWildcardArnV1UsEast1: arn:aws:acm:us-east-1:537124944731:certificate/c1f3daa3-fa88-4cb2-b3cc-0d5ca43d8d80
      dnsSuffix: crs.dev.account.gov.uk
    build:
      CertificateArn: arn:aws:acm:us-east-1:881490088364:certificate/e913c6e7-1b41-4d5a-8731-6f026ea12b62
      dnsSuffix: crs.build.account.gov.uk
    staging:
      CertificateArn: arn:aws:acm:us-east-1:253490791635:certificate/2a8b32c4-9893-476b-a57f-881029f00db0
      dnsSuffix: crs.staging.account.gov.uk
    integration:
      CertificateArn: PLACEHOLDER
      dnsSuffix: crs.integration.account.gov.uk
    production:
      CertificateArn: PLACEHOLDER
      dnsSuffix: crs.account.gov.uk

Conditions:
  UsePermissionsBoundary: !Not
    - !Equals
      - !Ref PermissionsBoundary
      - none

  UseCodeSigning: !Not
    - !Equals
      - !Ref CodeSigningConfigArn
      - none

  StackNameIsCrsBackend: !Equals
    - !Ref AWS::StackName
    - crs-backend

Transform: AWS::Serverless-2016-10-31

Globals:
  Function:
    AutoPublishAlias: live
    CodeSigningConfigArn: !If
      - UseCodeSigning
      - !Ref CodeSigningConfigArn
      - !Ref AWS::NoValue
    MemorySize: 512
    PermissionsBoundary: !If
      - UsePermissionsBoundary
      - !Ref PermissionsBoundary
      - !Ref AWS::NoValue
    Runtime: nodejs22.x
    Timeout: 3

Resources:
  FindAvailableSlotsFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        EntryPoints:
          - src/functions/findAvailableSlotsHandler.ts
    Properties:
      FunctionName: !Sub ${AWS::StackName}-find-available-slots
      Handler: src/functions/findAvailableSlotsHandler.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - AWSLambdaVPCAccessExecutionRole
      Events:
        ScheduledEvent:
          Type: Schedule
          Properties:
            Schedule: rate(1 minute)
      VpcConfig:
        SecurityGroupIds:
          - !ImportValue
            Fn::Sub: ${VpcStackName}-AWSServicesEndpointSecurityGroupId
        SubnetIds:
          - !ImportValue
            Fn::Sub: ${VpcStackName}-PrivateSubnetIdA
          - !ImportValue
            Fn::Sub: ${VpcStackName}-PrivateSubnetIdB
          - !ImportValue
            Fn::Sub: ${VpcStackName}-PrivateSubnetIdC
      Tags:
        Environment: !Ref Environment # This tag can be removed. Only here to appease cfn-lint and use the Environment parameter

  StatusListBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub ${AWS::StackName}-${Environment}-status-list
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256

  StatusListBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref StatusListBucket
      PolicyDocument:
        Statement:
          - Sid: AllowCloudFrontServicePrincipalReadOnly
            Action:
              - s3:GetObject
            Resource:
              - !Sub arn:aws:s3:::${StatusListBucket}/*
            Principal:
              Service: cloudfront.amazonaws.com
            Effect: Allow
            Condition:
              StringEquals:
                AWS:SourceArn: !Sub arn:aws:cloudfront::${AWS::AccountId}:distribution/${CredentialStatusCloudFrontDistribution}

  CredentialStatusRecordSet:
    Type: AWS::Route53::RecordSet
    Properties:
      Name: !Sub
        - ${dnsPrefix}${dnsSuffix}
        - dnsPrefix: !If
            - StackNameIsCrsBackend
            - ""
            - !Sub ${AWS::StackName}.
          dnsSuffix: !FindInMap
            - EnvironmentVariables
            - !Ref Environment
            - dnsSuffix
      Type: A
      HostedZoneId: !Sub '{{resolve:ssm:/${Environment}/Platform/Route53/PrimaryZoneID}}'
      AliasTarget:
        DNSName: !GetAtt CredentialStatusCloudFrontDistribution.DomainName
        HostedZoneId: Z2FDTNDATAQYW2

  CredentialStatusCloudFrontCachePolicy:
    Type: AWS::CloudFront::CachePolicy
    Properties:
      CachePolicyConfig:
        Comment: !Sub ${AWS::StackName} ${Environment} Credential Status
        DefaultTTL: 7200 # 2 hours
        MaxTTL: 39600 # 11 hours
        MinTTL: 0
        Name: !Sub ${AWS::StackName}-${Environment}-credential-status
        ParametersInCacheKeyAndForwardedToOrigin:
          CookiesConfig:
            CookieBehavior: none
          EnableAcceptEncodingGzip: false
          EnableAcceptEncodingBrotli: false
          HeadersConfig:
            HeaderBehavior: none
          QueryStringsConfig:
            QueryStringBehavior: none

  CredentialStatusCloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        Comment: !Sub ${AWS::StackName} ${Environment} Credential Status
        HttpVersion: http1.1
        Origins:
          - DomainName: !Sub ${StatusListBucket}.s3.${AWS::Region}.amazonaws.com
            Id: bucketOrigin
            # OriginAccessControlId: !Ref StatusListOriginAccessControl
            S3OriginConfig:
              OriginAccessIdentity: ""
        DefaultCacheBehavior:
          CachedMethods:
            - GET
            - HEAD
          AllowedMethods:
            - GET
            - HEAD
          TargetOriginId: bucketOrigin
          CachePolicyId: !Ref CredentialStatusCloudFrontCachePolicy
          ViewerProtocolPolicy: allow-all
        PriceClass: PriceClass_All
        Logging:
          Bucket: log-archive-cloudfront-logs-523017967436-eu-west-2.s3.amazonaws.com
          Prefix: !Sub ${AWS::AccountId}/${AWS::StackName}/
        Aliases:
          - !Sub
            - ${dnsPrefix}${dnsSuffix}
            - dnsPrefix: !If
                - StackNameIsCrsBackend
                - ""
                - !Sub ${AWS::StackName}.
              dnsSuffix: !FindInMap
                - EnvironmentVariables
                - !Ref Environment
                - dnsSuffix
        ViewerCertificate:
          AcmCertificateArn: !If
            - StackNameIsCrsBackend
            - !FindInMap
              - EnvironmentVariables
              - !Ref Environment
              - CertificateArnV1UsEast1
            - !FindInMap
              - EnvironmentVariables
              - dev
              - CertificateWildcardArnV1UsEast1
          MinimumProtocolVersion: TLSv1.2_2021
          SslSupportMethod: sni-only
